<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --panel2:#0f1630;
      --text:#eaf0ff;
      --muted:#a9b6e6;
      --ok:#2dd27d;
      --bad:#ff4d4d;
      --accent:#6aa4ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:radial-gradient(1200px 600px at 20% 10%, #1c2a5e 0%, var(--bg) 55%), var(--bg); color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);box-shadow:var(--shadow);
    }
    .left{display:flex;flex-direction:column;gap:6px}
    .title{font-weight:700;font-size:16px}
    .subtitle{color:var(--muted);font-size:12px}
    .right{display:flex;align-items:center;gap:12px}
    .counter{font-size:13px;color:var(--muted)}
    .timer{
      display:none;
      padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10); color:var(--text); font-size:13px;
    }
    .progress{
      width:240px;height:10px;border-radius:999px;overflow:hidden;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);
    }
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#9b7bff);transition:width .25s ease}
    .grid{display:grid;grid-template-columns: 1fr 1.2fr;gap:16px;margin-top:16px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .card-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
    .card-header .h{font-weight:700}
    .card-body{padding:16px}
    .deck{
      display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;
      padding:20px;min-height:320px;text-align:center;
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border-radius:var(--radius);
      border:1px dashed rgba(255,255,255,.18);
      cursor:pointer; user-select:none;
      transition:transform .08s ease, border-color .15s ease;
    }
    .deck:hover{border-color:rgba(255,255,255,.35)}
    .deck:active{transform:translateY(1px) scale(.995)}
    .deck .emoji{font-size:44px}
    .deck .big{font-weight:800;font-size:18px}
    .deck .small{color:var(--muted);font-size:13px}
    .task{
      display:flex;flex-direction:column;gap:12px;
    }
    .prompt{
      padding:12px 12px;border-radius:12px;background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .prompt .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .prompt .content{font-size:16px;line-height:1.35}
    .prompt img{max-width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.10)}
    audio{width:100%}
    .answer{
      padding:12px 12px;border-radius:12px;background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .answer .label{font-size:12px;color:var(--muted);margin-bottom:8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"]{
      flex:1;min-width:220px;
      background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);
      color:var(--text);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;
    }
    input[type="text"]:focus{border-color:rgba(106,164,255,.6);box-shadow:0 0 0 3px rgba(106,164,255,.12)}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      font-weight:650; font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.22)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(90deg,rgba(106,164,255,.35),rgba(155,123,255,.28));border-color:rgba(106,164,255,.35)}
    .btn.ghost{background:transparent}
    .feedback{
      display:none;
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
      font-size:14px;font-weight:650;
    }
    .feedback.ok{display:block;background:rgba(45,210,125,.14);border-color:rgba(45,210,125,.35);color:var(--ok)}
    .feedback.bad{display:block;background:rgba(255,77,77,.12);border-color:rgba(255,77,77,.35);color:var(--bad)}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .hidden{display:none !important}
    .end{
      display:none;
      padding:28px 18px; text-align:center;
    }
    .end .boom{font-size:46px}
    .end .h1{font-size:22px;font-weight:900;margin-top:10px}
    .end .p{color:var(--muted);margin-top:8px}
    .stats{margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .chip{
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      color:var(--text);font-size:13px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="left">
      <div class="title" id="uiTitle">–°–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã</div>
      <div class="subtitle" id="uiSubtitle">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç—É</div>
    </div>
    <div class="right">
      <div class="counter" id="uiCounter">0 / 0</div>
      <div class="timer" id="uiTimer">‚è± 00:00</div>
      <div class="progress" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å"><div class="bar" id="uiBar"></div></div>
    </div>
  </div>

  <div class="grid">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –∫–æ–ª–æ–¥–∞ -->
    <div class="card">
      <div class="card-header">
        <div class="h">–ö–æ–ª–æ–¥–∞</div>
        <button class="btn ghost" id="btnRestart">–°–Ω–∞—á–∞–ª–∞</button>
      </div>
      <div class="card-body">
        <div class="deck" id="deck">
          <div class="emoji">üÇ†</div>
          <div class="big" id="deckText">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</div>
          <div class="small" id="deckHint">–ö–∞—Ä—Ç—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è</div>
        </div>
        <div class="muted" style="margin-top:12px" id="rulesHint"></div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –∫–∞—Ä—Ç–∞/–∑–∞–¥–∞–Ω–∏–µ -->
    <div class="card">
      <div class="card-header">
        <div class="h">–ö–∞—Ä—Ç–∞</div>
        <div class="muted" id="cardMeta">‚Äî</div>
      </div>
      <div class="card-body">
        <div id="taskArea" class="task hidden">
          <div class="prompt">
            <div class="label">–ó–∞–¥–∞–Ω–∏–µ</div>
            <div class="content" id="promptContent"></div>
          </div>

          <div class="answer" id="answerBlock">
            <div class="label" id="answerLabel">–û—Ç–≤–µ—Ç</div>

            <div id="textAnswer" class="row hidden">
              <input id="answerInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." />
              <button class="btn primary" id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
              <button class="btn" id="btnNext" disabled>–î–∞–ª—å—à–µ</button>
            </div>

            <div id="oralAnswer" class="row hidden">
              <div class="muted" id="oralHint">–û—Ç–≤–µ—Ç—å—Ç–µ —É—Å—Ç–Ω–æ. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ‚Äú–î–∞–ª—å—à–µ‚Äù.</div>
              <button class="btn primary" id="btnNextOral">–î–∞–ª—å—à–µ</button>
            </div>

            <div class="feedback" id="feedback"></div>
          </div>
        </div>

        <div id="emptyState" class="muted">
          –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∫–∞—Ä—Ç–∞ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –ø–æ –∫–æ–ª–æ–¥–µ.
        </div>

        <div id="endScreen" class="end">
          <div class="boom">üéâ</div>
          <div class="h1" id="endTitle">–ì–æ—Ç–æ–≤–æ!</div>
          <div class="p" id="endText">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã.</div>
          <div class="stats" id="endStats"></div>
          <div style="margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn primary" id="btnRestart2">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
          </div>
          <audio id="fanfare" preload="auto"></audio>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * CONFIG ‚Äî –±—É–¥—É—â–∞—è —Ç–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.
 * –†–µ–¥–∞–∫—Ç–æ—Ä –±—É–¥–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç (–∏–ª–∏ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å JSON).
 */
const CONFIG = {
  meta: {
    title: "–°–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã",
    subtitle: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç—É",
  },
  settings: {
    // –û—Å–Ω–æ–≤–Ω–æ–µ:
    preventRepeats: true,          // –ó–∞–ø—Ä–µ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤ –∫–∞—Ä—Ç
    maxCardsToShow: 0,             // 0 = –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–∞—Ä—Ç—ã –∏–∑ –º–∞—Å—Å–∏–≤–∞; –∏–Ω–∞—á–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º—ã—Ö –∫–∞—Ä—Ç
    requiredCorrect: 0,            // 0 = –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å; –∏–Ω–∞—á–µ –∑–∞–∫–æ–Ω—á–∏—Ç—å –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ N –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ñ–∏–¥–±–µ–∫:
    enableAutoCheck: true,         // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫—É
    caseSensitive: false,          // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞
    trimAndNormalize: true,        // –£–¥–∞–ª—è—Ç—å –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã/–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å
    successText: "–í–µ—Ä–Ω–æ",
    errorText: "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑",

    // –¢–∞–π–º–µ—Ä:
    timerEnabled: false,           // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–∞–π–º–µ—Ä
    timerMode: "perCard",          // "perCard" | "overall"
    timerSeconds: 30,              // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫) –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ –Ω–∞ –∏–≥—Ä—É
    onTimeUp: "autoNext",          // "autoNext" | "markWrong" | "endGame"

    // –§–∏–Ω–∞–ª:
    endTitle: "–ì–æ—Ç–æ–≤–æ!",
    endTextAll: "–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã.",
    endTextCorrect: (n) => `–í—ã –Ω–∞–±—Ä–∞–ª–∏ ${n} –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤!`,
    fanfareUrl: ""                 // URL —Ñ–∞–Ω—Ñ–∞—Ä (mp3/ogg). –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º.
  },

  // –ö–∞—Ä—Ç—ã: —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è (text/image/audio) + —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ (text/oral)
  cards: [
    {
      id: "c1",
      prompt: { type: "text", value: "–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π: ¬´–Ø –ª—é–±–ª—é —É—á–∏—Ç—å—Å—è¬ª." },
      answer: { type: "text", value: "I love to study" }
    },
    {
      id: "c2",
      prompt: { type: "image", value: "https://images.unsplash.com/photo-1520975682031-a2c4d8c8cc2d?w=1200&q=80&auto=format&fit=crop" },
      answer: { type: "oral", value: "" }
    },
    {
      id: "c3",
      prompt: { type: "audio", value: "https://interactive-examples.mdn.mozilla.net/media/cc0-audio/t-rex-roar.mp3" },
      answer: { type: "text", value: "t-rex" }
    }
  ]
};

/* ========= –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã ========= */
const STATE = {
  deck: [],            // –∏–Ω–¥–µ–∫—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ä—Ç
  shown: 0,            // —Å–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç–æ
  correct: 0,          // —Å–∫–æ–ª—å–∫–æ –≤–µ—Ä–Ω—ã—Ö (–∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞)
  currentCard: null,   // –æ–±—ä–µ–∫—Ç –∫–∞—Ä—Ç—ã
  started: false,

  timer: {
    enabled: false,
    mode: "perCard",
    totalSeconds: 0,
    remaining: 0,
    intervalId: null
  }
};

/* ========= UI —ç–ª–µ–º–µ–Ω—Ç—ã ========= */
const uiTitle = document.getElementById("uiTitle");
const uiSubtitle = document.getElementById("uiSubtitle");
const uiCounter = document.getElementById("uiCounter");
const uiBar = document.getElementById("uiBar");
const uiTimer = document.getElementById("uiTimer");

const deckEl = document.getElementById("deck");
const deckText = document.getElementById("deckText");
const deckHint = document.getElementById("deckHint");
const rulesHint = document.getElementById("rulesHint");

const taskArea = document.getElementById("taskArea");
const emptyState = document.getElementById("emptyState");
const cardMeta = document.getElementById("cardMeta");
const promptContent = document.getElementById("promptContent");

const answerBlock = document.getElementById("answerBlock");
const answerLabel = document.getElementById("answerLabel");
const textAnswer = document.getElementById("textAnswer");
const oralAnswer = document.getElementById("oralAnswer");

const answerInput = document.getElementById("answerInput");
const btnCheck = document.getElementById("btnCheck");
const btnNext = document.getElementById("btnNext");
const btnNextOral = document.getElementById("btnNextOral");
const feedback = document.getElementById("feedback");

const btnRestart = document.getElementById("btnRestart");
const btnRestart2 = document.getElementById("btnRestart2");

const endScreen = document.getElementById("endScreen");
const endTitle = document.getElementById("endTitle");
const endText = document.getElementById("endText");
const endStats = document.getElementById("endStats");
const fanfare = document.getElementById("fanfare");

/* ========= –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ========= */
function initFromConfig() {
  uiTitle.textContent = CONFIG.meta.title || "–°–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã";
  uiSubtitle.textContent = CONFIG.meta.subtitle || "";

  STATE.timer.enabled = !!CONFIG.settings.timerEnabled;
  STATE.timer.mode = CONFIG.settings.timerMode || "perCard";
  STATE.timer.totalSeconds = Number(CONFIG.settings.timerSeconds || 0);
  uiTimer.style.display = STATE.timer.enabled ? "inline-flex" : "none";

  deckHint.textContent = CONFIG.settings.preventRepeats ? "–ö–∞—Ä—Ç—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è" : "–ü–æ–≤—Ç–æ—Ä—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã";

  const maxInfo = CONFIG.settings.maxCardsToShow && CONFIG.settings.maxCardsToShow > 0
    ? `–û—Ç–∫—Ä–æ–µ–º ${CONFIG.settings.maxCardsToShow} –∫–∞—Ä—Ç(—ã).`
    : `–û—Ç–∫—Ä–æ–µ–º –≤—Å–µ –∫–∞—Ä—Ç—ã: ${CONFIG.cards.length}.`;

  const goalInfo = CONFIG.settings.requiredCorrect && CONFIG.settings.requiredCorrect > 0
    ? `–¶–µ–ª—å: ${CONFIG.settings.requiredCorrect} –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.`
    : "–¶–µ–ª–∏ –ø–æ –≤–µ—Ä–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º –Ω–µ—Ç.";

  rulesHint.textContent = `${maxInfo} ${goalInfo}`;

  if (CONFIG.settings.fanfareUrl) fanfare.src = CONFIG.settings.fanfareUrl;
}

/* ========= –ö–æ–ª–æ–¥–∞ / —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å ========= */
function resetGame() {
  stopTimer();

  STATE.deck = CONFIG.cards.map((_, idx) => idx);
  STATE.shown = 0;
  STATE.correct = 0;
  STATE.currentCard = null;
  STATE.started = false;

  taskArea.classList.add("hidden");
  emptyState.classList.remove("hidden");
  endScreen.style.display = "none";

  feedback.className = "feedback";
  feedback.textContent = "";
  btnNext.disabled = true;
  answerInput.value = "";

  updateProgressUI();
  deckText.textContent = "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É";
  cardMeta.textContent = "‚Äî";

  if (STATE.timer.enabled && STATE.timer.mode === "overall") {
    STATE.timer.remaining = STATE.timer.totalSeconds;
    renderTimer();
  } else {
    uiTimer.textContent = "‚è± 00:00";
  }
}

function getMaxToShow() {
  const m = Number(CONFIG.settings.maxCardsToShow || 0);
  if (m > 0) return Math.min(m, CONFIG.cards.length);
  return CONFIG.cards.length;
}

function drawRandomCard() {
  const allowRepeats = !CONFIG.settings.preventRepeats;

  if (allowRepeats) {
    const idx = Math.floor(Math.random() * CONFIG.cards.length);
    return CONFIG.cards[idx];
  }

  if (STATE.deck.length === 0) return null;
  const r = Math.floor(Math.random() * STATE.deck.length);
  const idx = STATE.deck.splice(r, 1)[0];
  return CONFIG.cards[idx];
}

/* ========= –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã ========= */
function renderCard(card) {
  STATE.currentCard = card;

  emptyState.classList.add("hidden");
  endScreen.style.display = "none";
  taskArea.classList.remove("hidden");

  // meta
  cardMeta.textContent = `ID: ${card.id || "‚Äî"}`;

  // prompt
  promptContent.innerHTML = "";
  if (card.prompt.type === "text") {
    promptContent.textContent = card.prompt.value || "";
  } else if (card.prompt.type === "image") {
    const img = document.createElement("img");
    img.alt = "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è";
    img.src = card.prompt.value || "";
    promptContent.appendChild(img);
  } else if (card.prompt.type === "audio") {
    const audio = document.createElement("audio");
    audio.controls = true;
    audio.src = card.prompt.value || "";
    promptContent.appendChild(audio);
  } else {
    promptContent.textContent = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è";
  }

  // answer UI
  feedback.className = "feedback";
  feedback.textContent = "";
  btnNext.disabled = true;
  answerInput.value = "";

  const aType = card.answer?.type || "oral";
  if (aType === "text") {
    answerLabel.textContent = "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç";
    textAnswer.classList.remove("hidden");
    oralAnswer.classList.add("hidden");

    const canAutoCheck = !!CONFIG.settings.enableAutoCheck;
    btnCheck.style.display = canAutoCheck ? "inline-flex" : "none";
    btnNext.disabled = canAutoCheck; // –µ—Å–ª–∏ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞—Ç–µ–º "–î–∞–ª—å—à–µ"
    if (!canAutoCheck) btnNext.disabled = false; // –±–µ–∑ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–∞–ª—å—à–µ
  } else {
    answerLabel.textContent = "–£—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç";
    textAnswer.classList.add("hidden");
    oralAnswer.classList.remove("hidden");
  }

  // timer per card
  if (STATE.timer.enabled && STATE.timer.mode === "perCard") {
    STATE.timer.remaining = STATE.timer.totalSeconds;
    startTimer();
  }
}

/* ========= –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ ========= */
function normalize(s) {
  if (s == null) return "";
  let out = String(s);
  if (CONFIG.settings.trimAndNormalize) {
    out = out.trim().replace(/\s+/g, " ");
  }
  if (!CONFIG.settings.caseSensitive) {
    out = out.toLowerCase();
  }
  return out;
}

function checkAnswer() {
  const card = STATE.currentCard;
  if (!card) return;

  const user = normalize(answerInput.value);
  const right = normalize(card.answer?.value || "");

  const ok = user.length > 0 && user === right;

  if (ok) {
    feedback.className = "feedback ok";
    feedback.textContent = CONFIG.settings.successText || "–í–µ—Ä–Ω–æ";
    STATE.correct += 1;
    btnNext.disabled = false;
  } else {
    feedback.className = "feedback bad";
    feedback.textContent = CONFIG.settings.errorText || "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑";
    btnNext.disabled = true;
  }

  updateProgressUI();
  // –∫—Ä–∏—Ç–µ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
  if (CONFIG.settings.requiredCorrect > 0 && STATE.correct >= CONFIG.settings.requiredCorrect) {
    finishGame("correct");
  }
}

/* ========= –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π ========= */
function nextCard() {
  const maxToShow = getMaxToShow();

  if (!STATE.started) {
    STATE.started = true;
    if (STATE.timer.enabled && STATE.timer.mode === "overall") {
      startTimer();
    }
  }

  // –µ—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —Ñ–∏–Ω–∞–ª
  if (STATE.shown >= maxToShow) {
    finishGame("all");
    return;
  }

  const card = drawRandomCard();
  if (!card) {
    finishGame("all");
    return;
  }

  STATE.shown += 1;
  updateProgressUI();
  renderCard(card);
}

/* ========= –ü—Ä–æ–≥—Ä–µ—Å—Å ========= */
function updateProgressUI() {
  const maxToShow = getMaxToShow();
  uiCounter.textContent = `${Math.min(STATE.shown, maxToShow)} / ${maxToShow}`;

  const p = maxToShow > 0 ? (Math.min(STATE.shown, maxToShow) / maxToShow) * 100 : 0;
  uiBar.style.width = `${p}%`;

  // –Ω–∞–¥–ø–∏—Å—å –Ω–∞ –∫–æ–ª–æ–¥–µ
  if (STATE.shown >= maxToShow) {
    deckText.textContent = "–ö–æ–ª–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
  } else {
    deckText.textContent = STATE.shown === 0 ? "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É" : "–°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–∞";
  }
}

/* ========= –¢–∞–π–º–µ—Ä ========= */
function renderTimer() {
  const t = Math.max(0, STATE.timer.remaining);
  const mm = String(Math.floor(t / 60)).padStart(2, "0");
  const ss = String(t % 60).padStart(2, "0");
  uiTimer.textContent = `‚è± ${mm}:${ss}`;
}

function stopTimer() {
  if (STATE.timer.intervalId) clearInterval(STATE.timer.intervalId);
  STATE.timer.intervalId = null;
}

function handleTimeUp() {
  const mode = CONFIG.settings.onTimeUp || "autoNext";

  if (mode === "endGame") {
    finishGame("time");
    return;
  }

  if (mode === "markWrong") {
    // –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ (–¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ —ç—Ç–æ –±—É–¥–µ—Ç "–Ω–µ–≤–µ—Ä–Ω–æ")
    // –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å: —Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ –æ—à–∏–±–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ
  }

  // autoNext / markWrong:
  nextCard();
}

function startTimer() {
  stopTimer();
  if (!STATE.timer.enabled || STATE.timer.totalSeconds <= 0) return;

  renderTimer();
  STATE.timer.intervalId = setInterval(() => {
    STATE.timer.remaining -= 1;
    renderTimer();
    if (STATE.timer.remaining <= 0) {
      stopTimer();
      handleTimeUp();
    }
  }, 1000);
}

/* ========= –§–∏–Ω–∞–ª ========= */
function finishGame(reason) {
  stopTimer();

  taskArea.classList.add("hidden");
  emptyState.classList.add("hidden");
  endScreen.style.display = "block";

  endTitle.textContent = CONFIG.settings.endTitle || "–ì–æ—Ç–æ–≤–æ!";

  if (reason === "correct") {
    const n = STATE.correct;
    endText.textContent = typeof CONFIG.settings.endTextCorrect === "function"
      ? CONFIG.settings.endTextCorrect(n)
      : `–í—ã –Ω–∞–±—Ä–∞–ª–∏ ${n} –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤!`;
  } else if (reason === "time") {
    endText.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ.";
  } else {
    endText.textContent = CONFIG.settings.endTextAll || "–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã.";
  }

  endStats.innerHTML = "";
  endStats.appendChild(chip(`–û—Ç–∫—Ä—ã—Ç–æ: ${STATE.shown}/${getMaxToShow()}`));
  endStats.appendChild(chip(`–í–µ—Ä–Ω—ã—Ö: ${STATE.correct}`));
  endStats.appendChild(chip(`–ü–æ–≤—Ç–æ—Ä—ã: ${CONFIG.settings.preventRepeats ? "–Ω–µ—Ç" : "–¥–∞"}`));

  // —Ñ–∞–Ω—Ñ–∞—Ä—ã (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω URL)
  if (CONFIG.settings.fanfareUrl) {
    try { fanfare.currentTime = 0; fanfare.play().catch(()=>{}); } catch(e){}
  }
}

function chip(text) {
  const d = document.createElement("div");
  d.className = "chip";
  d.textContent = text;
  return d;
}

/* ========= –°–æ–±—ã—Ç–∏—è ========= */
deckEl.addEventListener("click", () => {
  // –µ—Å–ª–∏ —É–∂–µ –Ω–∞ —Ñ–∏–Ω–∞–ª–µ ‚Äî –Ω–µ –º–µ—à–∞–µ–º
  if (endScreen.style.display === "block") return;
  nextCard();
});

btnCheck.addEventListener("click", checkAnswer);
answerInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    if (btnCheck.style.display !== "none") checkAnswer();
    else nextCard();
  }
});

btnNext.addEventListener("click", nextCard);
btnNextOral.addEventListener("click", nextCard);

btnRestart.addEventListener("click", resetGame);
btnRestart2.addEventListener("click", resetGame);

/* ========= –°—Ç–∞—Ä—Ç ========= */
initFromConfig();
resetGame();
</script>
</body>
</html>
