<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --panel2:#0f1630;
      --text:#eaf0ff;
      --muted:#a9b6e6;
      --ok:#2dd27d;
      --bad:#ff4d4d;
      --accent:#6aa4ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:radial-gradient(1200px 600px at 20% 10%, #1c2a5e 0%, var(--bg) 55%), var(--bg); color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);box-shadow:var(--shadow);
    }
    .left{display:flex;flex-direction:column;gap:6px}
    .title{font-weight:700;font-size:16px}
    .subtitle{color:var(--muted);font-size:12px}
    .right{display:flex;align-items:center;gap:12px}
    .counter{font-size:13px;color:var(--muted)}
    .timer{
      display:none;
      padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10); color:var(--text); font-size:13px;
    }
    .progress{
      width:240px;height:10px;border-radius:999px;overflow:hidden;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);
    }
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#9b7bff);transition:width .25s ease}

    .grid{display:grid;grid-template-columns: 1fr 1.2fr;gap:16px;margin-top:16px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}

    .card{
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .card-header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
    .card-header .h{font-weight:700}
    .card-body{padding:16px}

    /* ===== –ö–æ–ª–æ–¥–∞ ===== */
    .deck-wrap{
      position:relative;
      min-height:320px;
      display:flex;align-items:center;justify-content:center;
      border-radius:var(--radius);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px dashed rgba(255,255,255,.18);
      cursor:pointer; user-select:none;
      transition:transform .08s ease, border-color .15s ease;
      overflow:hidden;
    }
    .deck-wrap:hover{border-color:rgba(255,255,255,.35)}
    .deck-wrap:active{transform:translateY(1px) scale(.995)}

    .deck-stack{
      position:relative;
      width:160px;height:220px;
      filter: drop-shadow(0 18px 22px rgba(0,0,0,.35));
    }
    .deck-card{
      position:absolute; inset:0;
      border-radius:16px;
      background: var(--back, linear-gradient(135deg,#2b3f8f,#6aa4ff));
      background-size:cover;
      background-position:center;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .deck-card:nth-child(1){ transform: translate(0px,0px) rotate(-2deg); }
    .deck-card:nth-child(2){ transform: translate(6px,6px) rotate(1deg); opacity:.96; }
    .deck-card:nth-child(3){ transform: translate(12px,12px) rotate(3deg); opacity:.92; }

    .deck-labels{
      margin-top:14px;
      text-align:center;
      display:flex;flex-direction:column;gap:6px;
    }
    .deck-labels .big{font-weight:800;font-size:16px}
    .deck-labels .small{color:var(--muted);font-size:13px}

    /* ===== –°—Ü–µ–Ω–∞ —Å–ø—Ä–∞–≤–∞ (–∫–∞—Ä—Ç–∞ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –∑–¥–µ—Å—å) ===== */
    #cardStage{
      position:relative;
      min-height:360px;
    }

    /* ===== Flying/Stage card core ===== */
    .fly-layer{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:999;
    }
    .fly-card{
      position:absolute;
      width:160px;height:220px;
      transform-style:preserve-3d;
      will-change:transform;
    }
    .fly-inner{
      width:100%;height:100%;
      position:relative;
      transform-style:preserve-3d;
      border-radius:16px;
      box-shadow: 0 18px 35px rgba(0,0,0,.45);
    }
    .fly-face{
      position:absolute; inset:0;
      border-radius:16px;
      backface-visibility:hidden;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
    }
    .fly-back{
      background: var(--back, linear-gradient(135deg,#2b3f8f,#6aa4ff));
      background-size:cover;
      background-position:center;
    }
    .fly-front{
      transform: rotateY(180deg);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      overflow:auto;
    }

    /* ===== –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å–ø—Ä–∞–≤–∞ ===== */
    .stage-card{
      width:100%;
      max-width:560px;
      margin:0 auto;
      perspective:1200px;
      pointer-events:auto;
    }
    .stage-card .fly-card{
      position:relative; /* —É–∂–µ –Ω–µ fixed */
      width:100%;
      height:auto;
      min-height:320px;
    }
    .stage-card .fly-inner{
      min-height:320px;
    }
    .stage-card .fly-front{
      padding:14px;
    }

    /* ===== UI –±–ª–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ª–∏—Ü–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞—Ä—Ç—ã ===== */
    .task{display:flex;flex-direction:column;gap:12px;}
    .prompt{
      padding:12px 12px;border-radius:12px;background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .prompt .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .prompt .content{font-size:16px;line-height:1.35}
    .prompt img{max-width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.10)}
    audio{width:100%}

    .answer{
      padding:12px 12px;border-radius:12px;background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .answer .label{font-size:12px;color:var(--muted);margin-bottom:8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"]{
      flex:1;min-width:220px;
      background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);
      color:var(--text);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;
    }
    input[type="text"]:focus{border-color:rgba(106,164,255,.6);box-shadow:0 0 0 3px rgba(106,164,255,.12)}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      font-weight:650; font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.22)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(90deg,rgba(106,164,255,.35),rgba(155,123,255,.28));border-color:rgba(106,164,255,.35)}
    .btn.ghost{background:transparent}
    .feedback{
      display:none;
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
      font-size:14px;font-weight:650;
    }
    .feedback.ok{display:block;background:rgba(45,210,125,.14);border-color:rgba(45,210,125,.35);color:var(--ok)}
    .feedback.bad{display:block;background:rgba(255,77,77,.12);border-color:rgba(255,77,77,.35);color:var(--bad)}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .hidden{display:none !important}

    .end{display:none;padding:28px 18px; text-align:center;}
    .end .boom{font-size:46px}
    .end .h1{font-size:22px;font-weight:900;margin-top:10px}
    .end .p{color:var(--muted);margin-top:8px}
    .stats{margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .chip{
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      color:var(--text);font-size:13px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="left">
      <div class="title" id="uiTitle">–°–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã</div>
      <div class="subtitle" id="uiSubtitle">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç—É</div>
    </div>
    <div class="right">
      <div class="counter" id="uiCounter">0 / 0</div>
      <div class="timer" id="uiTimer">‚è± 00:00</div>
      <div class="progress" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å"><div class="bar" id="uiBar"></div></div>
    </div>
  </div>

  <div class="grid">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –∫–æ–ª–æ–¥–∞ -->
    <div class="card" id="leftPanel">
      <div class="card-header">
        <div class="h">–ö–æ–ª–æ–¥–∞</div>
        <button class="btn ghost" id="btnRestart">–°–Ω–∞—á–∞–ª–∞</button>
      </div>
      <div class="card-body">
        <div class="deck-wrap" id="deck">
          <div>
            <div class="deck-stack" id="deckStack">
              <div class="deck-card"></div>
              <div class="deck-card"></div>
              <div class="deck-card"></div>
            </div>
            <div class="deck-labels">
              <div class="big" id="deckText">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</div>
              <div class="small" id="deckHint">–ö–∞—Ä—Ç—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è</div>
            </div>
          </div>
        </div>
        <div class="muted" style="margin-top:12px" id="rulesHint"></div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –∫–∞—Ä—Ç–∞/–∑–∞–¥–∞–Ω–∏–µ -->
    <div class="card" id="rightPanel">
      <div class="card-header">
        <div class="h">–ö–∞—Ä—Ç–∞</div>
        <div class="muted" id="cardMeta">‚Äî</div>
      </div>
      <div class="card-body">
        <div id="cardStage">
          <div id="stageEmpty" class="muted">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∫–∞—Ä—Ç–∞ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –ø–æ –∫–æ–ª–æ–¥–µ.</div>
        </div>

        <div id="endScreen" class="end">
          <div class="boom">üéâ</div>
          <div class="h1" id="endTitle">–ì–æ—Ç–æ–≤–æ!</div>
          <div class="p" id="endText">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã.</div>
          <div class="stats" id="endStats"></div>
          <div style="margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn primary" id="btnRestart2">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
          </div>
          <audio id="fanfare" preload="auto"></audio>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- —Å–ª–æ–π –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ -->
<div class="fly-layer" id="flyLayer"></div>

<script>
/* ================= CONFIG (–±—É–¥—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–µ–Ω—è–µ—Ç —ç—Ç–æ) ================= */
const CONFIG = {
  meta: {
    title: "–°–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã",
    subtitle: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç—É",
  },
  ui: {
    // URL —Ä—É–±–∞—à–∫–∏. –û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º ‚Äî –±—É–¥–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç.
    cardBackUrl: ""
  },
  settings: {
    preventRepeats: true,
    maxCardsToShow: 0,
    requiredCorrect: 0,

    enableAutoCheck: true,
    caseSensitive: false,
    trimAndNormalize: true,
    successText: "–í–µ—Ä–Ω–æ",
    errorText: "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑",

    timerEnabled: false,
    timerMode: "perCard",
    timerSeconds: 30,
    onTimeUp: "autoNext",

    endTitle: "–ì–æ—Ç–æ–≤–æ!",
    endTextAll: "–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã.",
    endTextCorrect: (n) => `–í—ã –Ω–∞–±—Ä–∞–ª–∏ ${n} –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤!`,
    fanfareUrl: ""
  },
  cards: [
    {
      id: "c1",
      prompt: { type: "text", value: "–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π: ¬´–Ø –ª—é–±–ª—é —É—á–∏—Ç—å—Å—è¬ª." },
      answer: { type: "text", value: "I love to study" }
    },
    {
      id: "c2",
      prompt: { type: "image", value: "https://images.unsplash.com/photo-1520975682031-a2c4d8c8cc2d?w=1200&q=80&auto=format&fit=crop" },
      answer: { type: "oral", value: "" }
    },
    {
      id: "c3",
      prompt: { type: "audio", value: "https://interactive-examples.mdn.mozilla.net/media/cc0-audio/t-rex-roar.mp3" },
      answer: { type: "text", value: "t-rex" }
    }
  ]
};

/* ================= STATE ================= */
const STATE = {
  deck: [],
  shown: 0,
  correct: 0,
  currentCard: null,
  started: false,
  busy: false,
  timer: { enabled:false, mode:"perCard", totalSeconds:0, remaining:0, intervalId:null }
};

/* ================= UI refs ================= */
const uiTitle = document.getElementById("uiTitle");
const uiSubtitle = document.getElementById("uiSubtitle");
const uiCounter = document.getElementById("uiCounter");
const uiBar = document.getElementById("uiBar");
const uiTimer = document.getElementById("uiTimer");

const deckEl = document.getElementById("deck");
const deckText = document.getElementById("deckText");
const deckHint = document.getElementById("deckHint");
const rulesHint = document.getElementById("rulesHint");
const deckStack = document.getElementById("deckStack");

const rightPanel = document.getElementById("rightPanel");
const cardMeta = document.getElementById("cardMeta");

const cardStage = document.getElementById("cardStage");
const stageEmpty = document.getElementById("stageEmpty");
let stagedCardEl = null;

const endScreen = document.getElementById("endScreen");
const endTitle = document.getElementById("endTitle");
const endText = document.getElementById("endText");
const endStats = document.getElementById("endStats");
const fanfare = document.getElementById("fanfare");

const btnRestart = document.getElementById("btnRestart");
const btnRestart2 = document.getElementById("btnRestart2");

const flyLayer = document.getElementById("flyLayer");

/* ================= helpers ================= */
function applyCardBackToDeck() {
  const url = (CONFIG.ui.cardBackUrl || "").trim();
  const cards = deckStack.querySelectorAll(".deck-card");
  cards.forEach(c => {
    if (url) c.style.setProperty("--back", `url("${url}")`);
    else c.style.removeProperty("--back");
  });
}
function normalize(s) {
  if (s == null) return "";
  let out = String(s);
  if (CONFIG.settings.trimAndNormalize) out = out.trim().replace(/\s+/g, " ");
  if (!CONFIG.settings.caseSensitive) out = out.toLowerCase();
  return out;
}
function chip(text) {
  const d = document.createElement("div");
  d.className = "chip";
  d.textContent = text;
  return d;
}
function getMaxToShow() {
  const m = Number(CONFIG.settings.maxCardsToShow || 0);
  if (m > 0) return Math.min(m, CONFIG.cards.length);
  return CONFIG.cards.length;
}

/* ================= timer ================= */
function stopTimer() {
  if (STATE.timer.intervalId) clearInterval(STATE.timer.intervalId);
  STATE.timer.intervalId = null;
}
function renderTimer() {
  const t = Math.max(0, STATE.timer.remaining);
  const mm = String(Math.floor(t / 60)).padStart(2, "0");
  const ss = String(t % 60).padStart(2, "0");
  uiTimer.textContent = `‚è± ${mm}:${ss}`;
}
function handleTimeUp() {
  const mode = CONFIG.settings.onTimeUp || "autoNext";
  if (mode === "endGame") return finishGame("time");
  return nextCard();
}
function startTimer() {
  stopTimer();
  if (!STATE.timer.enabled || STATE.timer.totalSeconds <= 0) return;
  renderTimer();
  STATE.timer.intervalId = setInterval(() => {
    STATE.timer.remaining -= 1;
    renderTimer();
    if (STATE.timer.remaining <= 0) {
      stopTimer();
      handleTimeUp();
    }
  }, 1000);
}

/* ================= init/reset ================= */
function initFromConfig() {
  uiTitle.textContent = CONFIG.meta.title || "–°–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã";
  uiSubtitle.textContent = CONFIG.meta.subtitle || "";

  STATE.timer.enabled = !!CONFIG.settings.timerEnabled;
  STATE.timer.mode = CONFIG.settings.timerMode || "perCard";
  STATE.timer.totalSeconds = Number(CONFIG.settings.timerSeconds || 0);
  uiTimer.style.display = STATE.timer.enabled ? "inline-flex" : "none";

  deckHint.textContent = CONFIG.settings.preventRepeats ? "–ö–∞—Ä—Ç—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è" : "–ü–æ–≤—Ç–æ—Ä—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã";

  const maxInfo = (CONFIG.settings.maxCardsToShow && CONFIG.settings.maxCardsToShow > 0)
    ? `–û—Ç–∫—Ä–æ–µ–º ${CONFIG.settings.maxCardsToShow} –∫–∞—Ä—Ç(—ã).`
    : `–û—Ç–∫—Ä–æ–µ–º –≤—Å–µ –∫–∞—Ä—Ç—ã: ${CONFIG.cards.length}.`;
  const goalInfo = (CONFIG.settings.requiredCorrect && CONFIG.settings.requiredCorrect > 0)
    ? `–¶–µ–ª—å: ${CONFIG.settings.requiredCorrect} –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.`
    : "–¶–µ–ª–∏ –ø–æ –≤–µ—Ä–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º –Ω–µ—Ç.";
  rulesHint.textContent = `${maxInfo} ${goalInfo}`;

  if (CONFIG.settings.fanfareUrl) fanfare.src = CONFIG.settings.fanfareUrl;
  applyCardBackToDeck();
}
function updateProgressUI() {
  const maxToShow = getMaxToShow();
  uiCounter.textContent = `${Math.min(STATE.shown, maxToShow)} / ${maxToShow}`;
  const p = maxToShow > 0 ? (Math.min(STATE.shown, maxToShow) / maxToShow) * 100 : 0;
  uiBar.style.width = `${p}%`;
  deckText.textContent = (STATE.shown >= maxToShow) ? "–ö–æ–ª–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞" : (STATE.shown === 0 ? "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É" : "–°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–∞");
}
function clearStage() {
  if (stagedCardEl) stagedCardEl.remove();
  stagedCardEl = null;
  stageEmpty.classList.remove("hidden");
  cardMeta.textContent = "‚Äî";
}
function resetGame() {
  stopTimer();
  STATE.deck = CONFIG.cards.map((_, idx) => idx);
  STATE.shown = 0;
  STATE.correct = 0;
  STATE.currentCard = null;
  STATE.started = false;
  STATE.busy = false;

  endScreen.style.display = "none";
  clearStage();

  updateProgressUI();

  if (STATE.timer.enabled && STATE.timer.mode === "overall") {
    STATE.timer.remaining = STATE.timer.totalSeconds;
    renderTimer();
  } else {
    uiTimer.textContent = "‚è± 00:00";
  }
}

/* ================= deck draw ================= */
function drawRandomCard() {
  const allowRepeats = !CONFIG.settings.preventRepeats;
  if (allowRepeats) return CONFIG.cards[Math.floor(Math.random() * CONFIG.cards.length)];
  if (STATE.deck.length === 0) return null;
  const r = Math.floor(Math.random() * STATE.deck.length);
  const idx = STATE.deck.splice(r, 1)[0];
  return CONFIG.cards[idx];
}

/* ================= build front content ================= */
function buildFrontContent(card, onNext) {
  const wrap = document.createElement("div");
  wrap.className = "task";

  const prompt = document.createElement("div");
  prompt.className = "prompt";
  prompt.innerHTML = `<div class="label">–ó–∞–¥–∞–Ω–∏–µ</div><div class="content"></div>`;
  const promptBody = prompt.querySelector(".content");

  if (card.prompt.type === "text") {
    promptBody.textContent = card.prompt.value || "";
  } else if (card.prompt.type === "image") {
    const img = document.createElement("img");
    img.alt = "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è";
    img.src = card.prompt.value || "";
    promptBody.appendChild(img);
  } else if (card.prompt.type === "audio") {
    const audio = document.createElement("audio");
    audio.controls = true;
    audio.src = card.prompt.value || "";
    promptBody.appendChild(audio);
  } else {
    promptBody.textContent = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è";
  }

  const answer = document.createElement("div");
  answer.className = "answer";

  const aType = card.answer?.type || "oral";

  const label = document.createElement("div");
  label.className = "label";
  label.textContent = (aType === "text") ? "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç" : "–£—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç";
  answer.appendChild(label);

  const fb = document.createElement("div");
  fb.className = "feedback";
  answer.appendChild(fb);

  if (aType === "text") {
    const row = document.createElement("div");
    row.className = "row";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...";
    input.autocomplete = "off";

    const btnCheckLocal = document.createElement("button");
    btnCheckLocal.className = "btn primary";
    btnCheckLocal.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";

    const btnNextLocal = document.createElement("button");
    btnNextLocal.className = "btn";
    btnNextLocal.textContent = "–î–∞–ª—å—à–µ";
    btnNextLocal.disabled = !!CONFIG.settings.enableAutoCheck;

    function setFeedback(ok) {
      if (ok) {
        fb.className = "feedback ok";
        fb.textContent = CONFIG.settings.successText || "–í–µ—Ä–Ω–æ";
      } else {
        fb.className = "feedback bad";
        fb.textContent = CONFIG.settings.errorText || "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑";
      }
    }

    function check() {
      const user = normalize(input.value);
      const right = normalize(card.answer?.value || "");
      const ok = user.length > 0 && user === right;

      if (ok) {
        STATE.correct += 1;
        btnNextLocal.disabled = false;
      } else {
        btnNextLocal.disabled = true;
      }
      setFeedback(ok);
      updateProgressUI();

      if (CONFIG.settings.requiredCorrect > 0 && STATE.correct >= CONFIG.settings.requiredCorrect) {
        finishGame("correct");
      }
    }

    if (CONFIG.settings.enableAutoCheck) {
      btnCheckLocal.addEventListener("click", check);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") check();
      });
    } else {
      btnCheckLocal.style.display = "none";
      btnNextLocal.disabled = false;
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") onNext();
      });
    }

    btnNextLocal.addEventListener("click", onNext);

    row.appendChild(input);
    row.appendChild(btnCheckLocal);
    row.appendChild(btnNextLocal);
    answer.appendChild(row);
  } else {
    const row = document.createElement("div");
    row.className = "row";

    const hint = document.createElement("div");
    hint.className = "muted";
    hint.textContent = "–û—Ç–≤–µ—Ç—å—Ç–µ —É—Å—Ç–Ω–æ. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ‚Äú–î–∞–ª—å—à–µ‚Äù.";

    const btnNextLocal = document.createElement("button");
    btnNextLocal.className = "btn primary";
    btnNextLocal.textContent = "–î–∞–ª—å—à–µ";
    btnNextLocal.addEventListener("click", onNext);

    row.appendChild(hint);
    row.appendChild(btnNextLocal);
    answer.appendChild(row);
  }

  wrap.appendChild(prompt);
  wrap.appendChild(answer);
  return wrap;
}

/* ================= animation: draw & flip, then STAGE the card ================= */
function createFlyingCardEl() {
  const fly = document.createElement("div");
  fly.className = "fly-card";

  const inner = document.createElement("div");
  inner.className = "fly-inner";

  const back = document.createElement("div");
  back.className = "fly-face fly-back";

  const front = document.createElement("div");
  front.className = "fly-face fly-front";

  const url = (CONFIG.ui.cardBackUrl || "").trim();
  if (url) fly.style.setProperty("--back", `url("${url}")`);

  inner.appendChild(back);
  inner.appendChild(front);
  fly.appendChild(inner);
  flyLayer.appendChild(fly);

  return { fly, inner, front };
}

function getCenterRect(el) {
  const r = el.getBoundingClientRect();
  return { x: r.left + r.width/2, y: r.top + r.height/2, w: r.width, h: r.height };
}

async function animateDrawAndStage(card) {
  // —É–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é –∫–∞—Ä—Ç—É
  clearStage();
  stageEmpty.classList.add("hidden");
  endScreen.style.display = "none";

  // —Å–æ–∑–¥–∞—ë–º –ª–µ—Ç–∞—é—â—É—é –∫–∞—Ä—Ç—É
  const { fly, inner, front } = createFlyingCardEl();

  // –Ω–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Ü–µ–≤—É—é —Å—Ç–æ—Ä–æ–Ω—É –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –°–†–ê–ó–£, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–µ –æ–Ω —É–∂–µ –±—ã–ª
  front.innerHTML = "";
  front.appendChild(buildFrontContent(card, nextCard));

  // —Å—Ç–∞—Ä—Ç ‚Äî —Ü–µ–Ω—Ç—Ä –∫–æ–ª–æ–¥—ã
  const start = getCenterRect(deckStack);
  // –∫–æ–Ω–µ—Ü ‚Äî —Ü–µ–Ω—Ç—Ä —Å—Ü–µ–Ω—ã —Å–ø—Ä–∞–≤–∞
  const end = getCenterRect(cardStage);

  const W = 160, H = 220;
  fly.style.left = (start.x - W/2) + "px";
  fly.style.top  = (start.y - H/2) + "px";

  fly.style.transform = `translate(0px,0px) rotateZ(-6deg) scale(1)`;
  inner.style.transform = `rotateY(0deg)`;

  const dx = (end.x - start.x) * 0.90;
  const dy = (end.y - start.y) * 0.10;

  const flight = fly.animate([
    { transform: `translate(0px,0px) rotateZ(-6deg) scale(1)` },
    { transform: `translate(${dx*0.55}px,${dy*0.30}px) rotateZ(2deg) scale(1.02)` },
    { transform: `translate(${dx}px,${dy}px) rotateZ(0deg) scale(1.03)` },
  ], {
    duration: 520,
    easing: "cubic-bezier(.2,.9,.2,1)",
    fill: "forwards"
  });

  const flip = inner.animate([
    { transform: "rotateY(0deg)" },
    { transform: "rotateY(180deg)" },
  ], {
    duration: 520,
    delay: 110,
    easing: "cubic-bezier(.2,.9,.2,1)",
    fill: "forwards"
  });

  await Promise.all([flight.finished, flip.finished]).catch(()=>{});

  // === –∑–∞–∫—Ä–µ–ø–ª—è–µ–º –∫–∞—Ä—Ç—É –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ ===
  const holder = document.createElement("div");
  holder.className = "stage-card";

  // –ø–µ—Ä–µ–Ω–æ—Å–∏–º fly-–∫–∞—Ä—Ç—É —Å–æ —Å–ª–æ—è fixed –≤–Ω—É—Ç—Ä—å —Å—Ü–µ–Ω—ã
  flyLayer.removeChild(fly);
  holder.appendChild(fly);

  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º absolute positioning –∏ transform
  fly.style.position = "relative";
  fly.style.left = "0";
  fly.style.top = "0";
  fly.style.transform = "none";

  // –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç front)
  inner.style.transform = "rotateY(180deg)";

  // —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ —Å—Ü–µ–Ω—ã (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ)
  fly.style.width = "100%";
  fly.style.height = "auto";
  fly.style.minHeight = "320px";

  stagedCardEl = holder;
  cardStage.appendChild(holder);
}

function updateCardMeta(card) {
  cardMeta.textContent = `ID: ${card.id || "‚Äî"}`;
}

/* ================= finish game ================= */
function finishGame(reason) {
  stopTimer();

  // —É–±–∏—Ä–∞–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é –∫–∞—Ä—Ç—É
  clearStage();
  endScreen.style.display = "block";

  endTitle.textContent = CONFIG.settings.endTitle || "–ì–æ—Ç–æ–≤–æ!";
  if (reason === "correct") {
    const n = STATE.correct;
    endText.textContent = typeof CONFIG.settings.endTextCorrect === "function"
      ? CONFIG.settings.endTextCorrect(n)
      : `–í—ã –Ω–∞–±—Ä–∞–ª–∏ ${n} –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤!`;
  } else if (reason === "time") {
    endText.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ.";
  } else {
    endText.textContent = CONFIG.settings.endTextAll || "–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã.";
  }

  endStats.innerHTML = "";
  endStats.appendChild(chip(`–û—Ç–∫—Ä—ã—Ç–æ: ${STATE.shown}/${getMaxToShow()}`));
  endStats.appendChild(chip(`–í–µ—Ä–Ω—ã—Ö: ${STATE.correct}`));
  endStats.appendChild(chip(`–ü–æ–≤—Ç–æ—Ä—ã: ${CONFIG.settings.preventRepeats ? "–Ω–µ—Ç" : "–¥–∞"}`));

  if (CONFIG.settings.fanfareUrl) {
    try { fanfare.currentTime = 0; fanfare.play().catch(()=>{}); } catch(e){}
  }
}

/* ================= next card ================= */
async function nextCard() {
  if (STATE.busy) return;
  if (endScreen.style.display === "block") return;

  const maxToShow = getMaxToShow();

  if (!STATE.started) {
    STATE.started = true;
    if (STATE.timer.enabled && STATE.timer.mode === "overall") {
      STATE.timer.remaining = STATE.timer.totalSeconds;
      startTimer();
    }
  }

  if (STATE.shown >= maxToShow) return finishGame("all");

  const card = drawRandomCard();
  if (!card) return finishGame("all");

  STATE.busy = true;

  // —Ç–∞–π–º–µ—Ä perCard –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–Ω–æ–≤–æ
  if (STATE.timer.enabled && STATE.timer.mode === "perCard") {
    STATE.timer.remaining = STATE.timer.totalSeconds;
    startTimer();
  }

  // –∞–Ω–∏–º–∞—Ü–∏—è + –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å–ø—Ä–∞–≤–∞
  STATE.currentCard = card;
  STATE.shown += 1;
  updateProgressUI();
  updateCardMeta(card);

  await animateDrawAndStage(card);

  // –∫—Ä–∏—Ç–µ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–Ω–∞ —Å–ª—É—á–∞–π requiredCorrect=0 ‚Äî –ø–æ –∫–æ–ª-–≤—É)
  if (STATE.shown >= maxToShow && (CONFIG.settings.requiredCorrect || 0) === 0) {
    // –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –Ω–∞–∂–∞—Ç—å ‚Äú–î–∞–ª—å—à–µ‚Äù –∏–ª–∏ –¥–æ–±—Ä–∞—Ç—å –≤–µ—Ä–Ω—ã–µ
  }

  STATE.busy = false;
}

/* ================= events ================= */
deckEl.addEventListener("click", nextCard);
btnRestart.addEventListener("click", resetGame);
btnRestart2.addEventListener("click", resetGame);

/* ================= start ================= */
initFromConfig();
resetGame();
</script>
</body>
</html>
